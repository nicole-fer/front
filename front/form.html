<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário</title>
    <link rel="stylesheet" href="form.css">
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
    <main>              <!--Formulário-->
        <h1> <i class="small material-icons">assignment_ind</i>Dados Pessoais</h1>
        <div class="row">
            <form id="form-cadastro" class="col s12">
                <div class="row">
                    <div class="input-field col s6">
                        <input placeholder="CPF" name="txtcpf" id="txtcpf" type="text" class="validate" >
                        <label for="cpf"></label>
                    </div>
                    <div class="input-field col s6">
                        <input placeholder="CadSus" name="txtcadSus" id="txtcadSus" type="text" class="validate">
                        <label for="CadSus"></label>
                    </div>
                    <div class="input-field col s12">
                        <input placeholder="Nome Completo" name="txtname" id="txtname" type="text" class="validate">
                        <label for="name"></label>
                    </div>
                    <div class="input-field col s4">
                        <input placeholder="DD/MM/AAAA" name="txtdate" id="txtdate" type="text" class="datepicker" data-mask="00/00/0000">
                    </div>
                    <div class="input-field col s4">
                        <select name="txtSexo" id="txtSexo">
                          <option value=""selected disabled></option>
                          <option value="Feminino">Feminino</option>
                          <option value="Masculino">Masculino</option>
                        </select>
                        <label>Sexo</label>
                    </div>
                    <div class="input-field col s4">
                        <select name="txtCor" id="txtCor">
                          <option  value=""selected disabled></option>
                          <option value="Branca">Branca</option>
                          <option value="Amarela">Amarela</option>
                          <option value="Parda">Parda</option>
                          <option value="Preta">Preta</option>
                          <option value="Indigena">Indigena</option>
                        </select>
                        <label>Raça/Cor</label>
                    </div>
                    <div class="input-field col s8">
                        <input placeholder="Mãe" id="txtmae" type="text" class="validate">
                        <label for="mae"></label>
                    </div>
                    <div class="input-field col s3">
                        <label>
                            <input name="checkboxMae" id="checkboxMae" type="checkbox" onclick="desabilitaMae('sim')" />
                            <span>Mãe Desconhecida</span>
                          </label>
                    </div>
                    <div class="input-field col s8">
                        <input placeholder="Pai" name="txtpai" id="txtpai" type="text" class="validate">
                        <label for="pai"></label>
                    </div>
                    <div class="input-field col s3">
                        <label>
                            <input name="checkboxPai" id="checkboxPai" type="checkbox" onclick="desabilitaPai('sim')" />
                            <span>Pai Desconhecido</span>
                          </label>
                    </div>

                    <div class="input-field col s5">
                        <select id="uf" name="uf">
                            <option value="">Selecione o Estado</option>
                        </select>
                        <label>Estado Nascimento</label>
                    </div>

                    <div class="input-field col s5">
                        <select id="city" name="city">
                          <option value="">Selecione o Estado</option>
                        </select>
                        <label>Cidade</label>
                    </div>

                    <div class="input-field col s12">
                        <label>
                            <input name="checkboxFaleceu" type="checkbox" />
                            <span>Faleceu?</span>
                          </label>
                    </div>

                    <div class="input-field col s4">
                        <br><br>
                        <a class="waves-effect grey darken-3 btn" value="Salvar Dados" class="butt" onclick="save()" >Salvar Dados</a>
                    </div>
                    <div class="input-field col s4">
                        <br><br>
                        <a class="waves-effect grey darken-3 btn" value="Apagar Dados" class="butt" onclick="delet()">Limpar Formulário</a>
                    </div>
                                       
                        <div class="input-field col s4">
                    <br><br>
                        <a class="waves-effect blue accent-3 btn" value="Registrar Dados" class="butt" onclick="logout()">Logout</a>
                    </div>
                </div>
            </form>
        </div>
        <hr>
    </form>
</main>

<table id="Dados"></table>
<!-- Compiled and minified JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="jquery.mask.min.js"></script>

    <script>

        /*  mascaras em jquery  */
        $('document').ready(function(){
            estaAutorizado();
            $("#txtcpf").mask('000.000.000-00')
            $("#txtcadSus").mask('000 0000 0000 0000')
            $("#txtdate").mask("00/00/0000");
            getUf()
            getPessoas1()
                
        });
        $('#uf').change(function(){
            getCityByUf($('#uf').val())
        })

            /// select em JS
        document.addEventListener('DOMContentLoaded', function() {
            var sel = document.querySelectorAll('select');
            M.FormSelect.init(sel);
        });

        /*  pegar os dados de Estado e Cidade */
        const getUf = () => {
            $.ajax({
                url: 'http://172.16.34.244:1500/api/uf',
                success: function(response) {
                    $("#uf").html('<option value="">Selecione o Estado</option>')
                    $.each(response, function(index, value) {
                        $("#uf").append(
                            `<option value="${value.id}">${value.uf_full_name} (${value.uf})</option>`
                        )
                    })
                    M.FormSelect.init(document.getElementById('uf'))
                },
                error: function(error) {
                    erro = error.responseJSON.message
                    alert(erro)
                }
            })
        }
        const getCityByUf = (uf_id) => {
            $.ajax({
                url: 'http://172.16.34.244:1500/api/city',
                data: {"uf_id" : uf_id},
                success: function(response) {
                    $("#city").html('<option value="">Selecione a Cidade</option>')
                    $.each(response.data, function(index, value) {
                        $("#city").append(
                            `<option value="${value.id}">${value.city}</option>`
                        )
                    })
                    M.FormSelect.init(document.getElementById('city'))
                },
                error: function(error) {
                    erro = error.responseJSON.message
                    alert(erro)
                }
            })
        }

            function desabilitaMae(valor) {
                var status = document.getElementById('txtmae').disabled
                if (valor === 'sim' && !status) {
                    document.getElementById('txtmae').disabled = true
                } else {
                    document.getElementById('txtmae').disabled = false
                }
            }
            function desabilitaPai(valor) {
                var status = document.getElementById('txtpai').disabled
                if (valor === 'sim' && !status) {
                    document.getElementById('txtpai').disabled = true
                } else {
                    document.getElementById('txtpai').disabled = false
                }
            }
            //verifica se o token é valido e autoriza o login
            const estaAutorizado = () => {
                const token = localStorage.getItem("token");
                if(!localStorage.getItem("token")) {
                    alert('Não autenticado')
                    window.location = "login.html"
                }
                $.ajax({
                        url:'http://172.16.34.244:1500/api/user',
                        headers: {
                            "Accept": "application/json",
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${token}`
                        },
                        success: function(response){
                            localStorage.setItem('nome_usuario_logado', response.name)
                            localStorage.setItem('id_usuario_logado', response.id)
                        },
                        error: function(error) {
                            erro = error.responseJSON.message
                            window.location = "login.html"
                            alert(erro)
                        }
                    })
                }
                function save() { 
                    let name =  $("#txtname").val()
                    let cpf = $("#txtcpf").val()
                    let birthdate = $("#txtdate").val().split('/')
                    birthdate= birthdate[1]+"-"+birthdate[0]+"-"+birthdate[2]
                    let cadsus = $("#txtcadSus").val()
                    cadsus = cadsus.split(' ').join('')
                    let sexo = $("#txtSexo").val()
                    let ethnicity = $("#txtCor").val()
                    let uf_id = $("#uf").val()
                    let city_id = $("#city").val()

                    const token = localStorage.getItem("token");

                    $.ajax({
                        method: "POST",
                        headers: {
                            "Accept": "application/json",
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${token}`
                        },
                        url: 'http://172.16.34.244:1500/api/people/create',
                        timeout: 0,
                        data: JSON.stringify({
                            name:`${name}`,
                            cpf:`${cpf}`,
                            birthdate:`${birthdate}`,
                            cadsus:`${cadsus}`,
                            sexo: `${sexo}`,
                            ethnicity: `${ethnicity}`,
                            uf_id: `${uf_id}`,
                            city_id: `${city_id}`
                        }),
                        success: function(response) {
                            alert("Pessoa Cadastrada com Sucesso")
                            $('#dados').append('Name')
                        },
                        error: function(error) {
                            erro = error.responseJSON.message
                            alert(erro)
                        }
                    }) 
                }
    </script>